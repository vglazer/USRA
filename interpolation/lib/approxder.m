% SYNTAX 
% approxder(x, y, appord) 
%
% DESCRIPTION
% approxder approximates the derivative values of the function x |-> y using 
% finite difference formulae of the specified order (which assume varying 
% degrees of smoothness). 
% 
% PARAMETERS
% x is the knot vector. x must be specified.
% 
% y is the data vector. y must be specified.
% 
% appord is the desired order of approximation. The supported choices are:
%   2  - uniform O(h^2) formulas
%   21 - nonuniform O(h^2) formulas
%   31 - nonuniform O(h^3) formulas [Lagrange form]
%   32 - nonuniform O(h^3) formulas [Newton form]
%   4  - uniform O(h^4) formulas
%   41 - nonuniform O(h^4) formulas [Lagrange form]
%   42 - Hyman's nonuniform "O(h^4)" formulas
%   43 - A modified version of Hyman's nonuniform "O(h^4)" formulas
%   44 - nonuniform O(h^4) formulas [Newton form]
% Newton O(h^3) formulas (32) perform best overall. appord must be specified.
% appord must be specified.
%
% EXAMPLES
% approxder(x, y, 32)
%   approximate the function using nonuniform O(h^3) formulas in Newton form
function d = approxder(x,y,appord)
n = length(y);
d = zeros(1,n);
switch appord
    case 2 % Uniform O(h^2) (three-point) finite difference formulas.
    k = 2:n-1;
    h = diff(x);

    d(k) = (y(k+1) - y(k-1))/sum(h(k-1:k));
    d(1) = (-3*y(1) + 4*y(2)   - y(3))  /sum(h(1:2));
    d(n) = ( 3*y(n) - 4*y(n-1) + y(n-2))/sum(h(n-2:n-1));
   
    case 21 % Nonuniform O(h^2) (three-point) finite difference approximation.
    k = 2:n-1;
    h = diff(x);

    %  Slopes at interior points (centered formula).
    hwsq = h(k-1).^2; hesq = h(k).^2; scalef = h(k-1).*h(k).*(h(k-1)+h(k));
    d(k) = (-hesq.*y(k-1) + (hesq-hwsq).*y(k) + hwsq.*y(k+1))./scalef; 

    % Slopes at endpoints (one-sided formulae).
    d(1) = (-(h(2)^2+2*h(1)*h(2))      *y(1) +     (h(1)+h(2))^2*y(2)   - ... 
               h(1)^2*  y(3))/(h(1)*(h(1)+h(2))*h(2));
    d(n) = (+(h(n-2)^2+2*h(n-1)*h(n-2))*y(n) - (h(n-1)+h(n-2))^2*y(n-1) + ...
               h(n-1)^2*y(n-2))/(h(n-1)*(h(n-1)+h(n-2))*h(n-2));

    case 31 % Nonuniform O(h^3) (four-point) formulas [in Lagrange form]
    xis = zeros(4,4);

    for i = 1:4
        for j = 1:4
            xis(i,j) = x(i)*x(j);
        end
    end
    w1 = (3*xis(1,1) - 2*(xis(2,1) + xis(3,1) + xis(4,1)) + ...
          xis(2,3) + xis(2,4) + xis(3,4)) / ...
         ((x(1) - x(4))*(xis(1,1) - xis(1,3) - xis(1,2) + xis(2,3)));
    w2 = (3*xis(1,1) - 2*(xis(1,1) + xis(3,1) + xis(4,1)) + ...
          xis(1,3) + xis(1,4) + xis(3,4)) / ...
         ((x(2) - x(4))*(xis(2,2) - xis(2,3) - xis(1,2) + xis(1,3)));
    w3 = (3*xis(1,1) - 2*(xis(1,1) + xis(2,1) + xis(4,1)) + ...
          xis(1,2) + xis(1,4) + xis(2,4)) / ...
         ((x(3) - x(4))*(xis(3,3) - xis(2,3) - xis(1,3) + xis(1,2)));
    w4 = (3*xis(1,1) - 2*(xis(1,1) + xis(2,1) + xis(3,1)) + ...
          xis(1,2) + xis(1,3) + xis(2,3)) / ...
         ((x(4) - x(3))*(xis(4,4) - xis(2,4) - xis(1,4) + xis(1,2)));
    d(1) = w1*y(1) + w2*y(2) + w3*y(3) + w4*y(4);

    for k = 2:n-2
        for i = 1:4
            for j = 1:4 
                xis(i,j) = x(k-2+i)*x(k-2+j);
            end
        end

        w1 = (3*xis(2,2) - 2*(xis(2,2) + xis(3,2) + xis(4,2)) + ...
              xis(2,3) + xis(2,4) + xis(3,4)) / ...
             ((x(k-1) - x(k+2))*(xis(1,1) - xis(1,3) - xis(1,2) + xis(2,3)));
        w2 = (3*xis(2,2) - 2*(xis(1,2) + xis(3,2) + xis(4,2)) + ...
              xis(1,3) + xis(1,4) + xis(3,4)) / ...
             ((x(k) - x(k+2))*(xis(2,2) - xis(2,3) - xis(1,2) + xis(1,3)));
        w3 = (3*xis(2,2) - 2*(xis(1,2) + xis(2,2) + xis(4,2)) + ...
              xis(1,2) + xis(1,4) + xis(2,4)) / ...
             ((x(k+1) - x(k+2))*(xis(3,3) - xis(2,3) - xis(1,3) + xis(1,2)));
        w4 = (3*xis(2,2) - 2*(xis(1,2) + xis(2,2) + xis(3,2)) + ...
              xis(1,2) + xis(1,3) + xis(2,3)) / ...
             ((x(k+2) - x(k+1))*(xis(4,4) - xis(2,4) - xis(1,4) + xis(1,2)));
        d(k) = w1*y(k-1) + w2*y(k) + w3*y(k+1) + w4*y(k+2);
    end

    for i = 1:4
        for j = 1:4
            xis(i,j) = x(n-4+i)*x(n-4+j);
        end
    end

    w1 = (3*xis(3,3) - 2*(xis(2,3) + xis(3,3) + xis(4,3)) + ...
          xis(2,3) + xis(2,4) + xis(3,4)) / ...
         ((x(n-3) - x(n))*(xis(1,1) - xis(1,3) - xis(1,2) + xis(2,3)));
    w2 = (3*xis(3,3) - 2*(xis(1,3) + xis(3,3) + xis(4,3)) + ...
          xis(1,3) + xis(1,4) + xis(3,4)) / ...
         ((x(n-2) - x(n))*(xis(2,2) - xis(2,3) - xis(1,2) + xis(1,3)));
    w3 = (3*xis(3,3) - 2*(xis(1,3) + xis(2,3) + xis(4,3)) + ...
          xis(1,2) + xis(1,4) + xis(2,4)) / ...
         ((x(n-1) - x(n))*(xis(3,3) - xis(2,3) - xis(1,3) + xis(1,2)));
    w4 = (3*xis(3,3) - 2*(xis(1,3) + xis(2,3) + xis(3,3)) + ...
          xis(1,2) + xis(1,3) + xis(2,3)) / ...
         ((x(n) - x(n-1))*(xis(4,4) - xis(2,4) - xis(1,4) + xis(1,2)));
    d(n-1) = w1*y(n-3) + w2*y(n-2) + w3*y(n-1) + w4*y(n);

    w1 = (3*xis(4,4) - 2*(xis(2,4) + xis(3,4) + xis(4,4)) + ...
          xis(2,3) + xis(2,4) + xis(3,4)) / ...
         ((x(n-3) - x(n))*(xis(1,1) - xis(1,3) - xis(1,2) + xis(2,3)));
    w2 = (3*xis(4,4) - 2*(xis(1,4) + xis(3,4) + xis(4,4)) + ...
          xis(1,3) + xis(1,4) + xis(3,4)) / ...
         ((x(n-2) - x(n))*(xis(2,2) - xis(2,3) - xis(1,2) + xis(1,3)));
    w3 = (3*xis(4,4) - 2*(xis(1,4) + xis(2,4) + xis(4,4)) + ...
          xis(1,2) + xis(1,4) + xis(2,4)) / ...
         ((x(n-1) - x(n))*(xis(3,3) - xis(2,3) - xis(1,3) + xis(1,2)));
    w4 = (3*xis(4,4) - 2*(xis(1,4) + xis(2,4) + xis(3,4)) + ...
          xis(1,2) + xis(1,3) + xis(2,3)) / ...
         ((x(n) - x(n-1))*(xis(4,4) - xis(2,4) - xis(1,4) + xis(1,2)));
    d(n) = w1*y(n-3) + w2*y(n-2) + w3*y(n-1) + w4*y(n);

    case 32 % Nonuniform O(h^3) formulas [in Newton form] 
    % Compute the first, second and third divided differences 
    [s,ds,e] = vecdiffs(x,y);

    % Approximate derivative values at the left boundary and interior points
    for k = 1:n-3
        d(k) = s(k) + ds(k)*(x(k) - x(k+1)) + ...
               e(k)*(x(k)^2 + x(k+1)*x(k+2) - x(k)*x(k+1) - x(k)*x(k+2));
    end

    % Approximate derivative values at the right boundary 
    w1 = 3*e(n-3);
    w2 = 2*(ds(n-3) - e(n-3)*(x(n-3) + x(n-2) + x(n-1)));
    rest = s(n-3) - ds(n-3)*(x(n-3) + x(n-2)) + ...
           e(n-3)*(x(n-3)*x(n-2) + x(n-3)*x(n-1) + x(n-2)*x(n-1));
    d(n-2) = w1*x(n-2)^2 + w2*x(n-2) + rest; 
    d(n-1) = w1*x(n-1)^2 + w2*x(n-1) + rest;
    d(n)   = w1*x(n)  ^2 + w2*x(n)   + rest;

    case 4 % Uniform O(h^4) (five-point) finite difference approximation.
    k = 3:n-2;
    h = diff(x);

    %  Slopes at interior points (centered formula).
    d(k) = (y(k-2) - 8*y(k-1) + 8*y(k + 1) - y(k+2))/ ...
           (3*sum(h(k-2:k+1)));

    % Slopes at endpoints and adjacent points 

    % One-sided formulae:
    d(1) = (-25*y(1) + 48*y(2)   - 36*y(3)   + 16*y(4)   - ...
              3*y(5))  /(3*sum(h(1:4)));
    d(n) = ( 25*y(n) - 48*y(n-1) + 36*y(n-2) - 16*y(n-3) + ... 
              3*y(n-4))/(3*sum(h(n-4:n-1)));
    % Partly one-sided formulae:
    d(2)   = (-3*y(1) - 10*y(2)   + 18*y(3)   - 6*y(4)   + ...
                 y(5))  /(3*sum(h(1:4)));
    d(n-1) = (+3*y(n) + 10*y(n-1) - 18*y(n-2) + 6*y(n-3) - ...
                 y(n-4))/(3*sum(h(n-4:n-1)));

    case 41 % Nonuniform O(h^4) formulas [in Lagrange form]
    xi2 = zeros(5,5);
    xi3 = zeros(5,5,5);

    for i = 1:5
        for j = 1:5
            xi2(i,j) = x(i)*x(j); 
            for k = 1:5
                xi3(i,j,k) = x(i)*x(j)*x(k);
            end
        end
    end
    w1 = (4*xi3(1,1,1) - 3*(x(2) + x(3) + x(4) + x(5))*xi2(1,1) + ...
          2*(xi2(2,3) + xi2(2,4) + xi2(2,5) + xi2(3,4) + xi2(3,5) + ...
             xi2(4,5))*x(1) - (xi3(2,3,4) + xi3(2,3,5) + xi3(2,4,5) + ...
             xi3(3,4,5)))/((x(1) - x(2))*(x(1) - x(3))* ...
                           (x(1) - x(4))*(x(1) - x(5)));        
    w2 = (4*xi3(1,1,1) - 3*(x(1) + x(3) + x(4) + x(5))*xi2(1,1) + ...
          2*(xi2(1,3) + xi2(1,4) + xi2(1,5) + xi2(3,4) + xi2(3,5) + ...
             xi2(4,5))*x(1) - (xi3(1,3,4) + xi3(1,3,5) + xi3(1,4,5) + ...
             xi3(3,4,5)))/((x(2) - x(1))*(x(2) - x(3))* ...
                           (x(2) - x(4))*(x(2) - x(5)));        
    w3 = (4*xi3(1,1,1) - 3*(x(1) + x(2) + x(4) + x(5))*xi2(1,1) + ...
          2*(xi2(1,2) + xi2(1,4) + xi2(1,5) + xi2(2,4) + xi2(2,5) + ...
             xi2(4,5))*x(1) - (xi3(1,2,4) + xi3(1,2,5) + xi3(1,4,5) + ...
             xi3(2,4,5)))/((x(3) - x(1))*(x(3) - x(2))* ...
                           (x(3) - x(4))*(x(3) - x(5)));        
    w4 = (4*xi3(1,1,1) - 3*(x(1) + x(2) + x(3) + x(5))*xi2(1,1) + ...
          2*(xi2(1,2) + xi2(1,3) + xi2(1,5) + xi2(2,3) + xi2(2,5) + ...
             xi2(3,5))*x(1) - (xi3(1,2,3) + xi3(1,2,5) + xi3(1,3,5) + ...
             xi3(2,3,5)))/((x(4) - x(1))*(x(4) - x(2))* ...
                           (x(4) - x(3))*(x(4) - x(5)));        
    w5 = (4*xi3(1,1,1) - 3*(x(1) + x(2) + x(3) + x(4))*xi2(1,1) + ...
          2*(xi2(1,2) + xi2(1,3) + xi2(1,4) + xi2(2,3) + xi2(2,4) + ...
             xi2(3,4))*x(1) - (xi3(1,2,3) + xi3(1,2,4) + xi3(1,3,4) + ...
             xi3(2,3,4)))/((x(5) - x(1))*(x(5) - x(2))* ...
                           (x(5) - x(3))*(x(5) - x(4)));        
    d(1) = w1*y(1) + w2*y(2) + w3*y(3) + w4*y(4) + w5*y(5);

    w1 = (4*xi3(2,2,2) - 3*(x(2) + x(3) + x(4) + x(5))*xi2(2,2) + ...
          2*(xi2(2,3) + xi2(2,4) + xi2(2,5) + xi2(3,4) + xi2(3,5) + ...
             xi2(4,5))*x(2) - (xi3(2,3,4) + xi3(2,3,5) + xi3(2,4,5) + ...
             xi3(3,4,5)))/((x(1) - x(2))*(x(1) - x(3))* ...
                           (x(1) - x(4))*(x(1) - x(5)));        
    w2 = (4*xi3(2,2,2) - 3*(x(1) + x(3) + x(4) + x(5))*xi2(2,2) + ...
          2*(xi2(1,3) + xi2(1,4) + xi2(1,5) + xi2(3,4) + xi2(3,5) + ...
             xi2(4,5))*x(2) - (xi3(1,3,4) + xi3(1,3,5) + xi3(1,4,5) + ...
             xi3(3,4,5)))/((x(2) - x(1))*(x(2) - x(3))* ...
                           (x(2) - x(4))*(x(2) - x(5)));        
    w3 = (4*xi3(2,2,2) - 3*(x(1) + x(2) + x(4) + x(5))*xi2(2,2) + ...
          2*(xi2(1,2) + xi2(1,4) + xi2(1,5) + xi2(2,4) + xi2(2,5) + ...
             xi2(4,5))*x(2) - (xi3(1,2,4) + xi3(1,2,5) + xi3(1,4,5) + ...
             xi3(2,4,5)))/((x(3) - x(1))*(x(3) - x(2))* ...
                           (x(3) - x(4))*(x(3) - x(5)));        
    w4 = (4*xi3(2,2,2) - 3*(x(1) + x(2) + x(3) + x(5))*xi2(2,2) + ...
          2*(xi2(1,2) + xi2(1,3) + xi2(1,5) + xi2(2,3) + xi2(2,5) + ...
             xi2(3,5))*x(2) - (xi3(1,2,3) + xi3(1,2,5) + xi3(1,3,5) + ...
             xi3(2,3,5)))/((x(4) - x(1))*(x(4) - x(2))* ...
                           (x(4) - x(3))*(x(4) - x(5)));        
    w5 = (4*xi3(2,2,2) - 3*(x(1) + x(2) + x(3) + x(4))*xi2(2,2) + ...
          2*(xi2(1,2) + xi2(1,3) + xi2(1,4) + xi2(2,3) + xi2(2,4) + ...
             xi2(3,4))*x(2) - (xi3(1,2,3) + xi3(1,2,4) + xi3(1,3,4) + ...
             xi3(2,3,4)))/((x(5) - x(1))*(x(5) - x(2))* ...
                           (x(5) - x(3))*(x(5) - x(4)));        
    d(2) = w1*y(1) + w2*y(2) + w3*y(3) + w4*y(4) + w5*y(5);
 
    for k = 3:n-2
        for i = 1:5
            for j = 1:5
                xi2(i,j) = x(k-3+i)*x(k-3+j); 
                for h = 1:5
                    xi3(i,j,h) = x(k-3+i)*x(k-3+j)*x(k-3+h);
                end
            end
        end

        w1 = (4*xi3(3,3,3) - 3*(x(k-1) + x(k) + x(k+1) + x(k+2))*xi2(3,3) + ...
              2*(xi2(2,3) + xi2(2,4) + xi2(2,5) + xi2(3,4) + xi2(3,5) + ...
                 xi2(4,5))*x(k) - (xi3(2,3,4) + xi3(2,3,5) + xi3(2,4,5) + ...
                 xi3(3,4,5)))/((x(k-2) - x(k-1))*(x(k-2) - x(k))* ...
                               (x(k-2) - x(k+1))*(x(k-2) - x(k+2)));        
        w2 = (4*xi3(3,3,3) - 3*(x(k-2) + x(k) + x(k+1) + x(k+2))*xi2(3,3) + ...
              2*(xi2(1,3) + xi2(1,4) + xi2(1,5) + xi2(3,4) + xi2(3,5) + ...
                 xi2(4,5))*x(k) - (xi3(1,3,4) + xi3(1,3,5) + xi3(1,4,5) + ...
                 xi3(3,4,5)))/((x(k-1) - x(k-2))*(x(k-1) - x(k))* ...
                               (x(k-1) - x(k+1))*(x(k-1) - x(k+2)));        
        w3 = (4*xi3(3,3,3) - 3*(x(k-2) + x(k-1) + x(k+1) + x(k+2))*xi2(3,3)+ ...
              2*(xi2(1,2) + xi2(1,4) + xi2(1,5) + xi2(2,4) + xi2(2,5) + ...
                 xi2(4,5))*x(k) - (xi3(1,2,4) + xi3(1,2,5) + xi3(1,4,5) + ...
                 xi3(2,4,5)))/((x(k) - x(k-2))*(x(k) - x(k-1))* ...
                               (x(k) - x(k+1))*(x(k) - x(k+2)));        
        w4 = (4*xi3(3,3,3) - 3*(x(k-2) + x(k-1) + x(k) + x(k+2))*xi2(3,3) + ...
              2*(xi2(1,2) + xi2(1,3) + xi2(1,5) + xi2(2,3) + xi2(2,5) + ...
                 xi2(3,5))*x(k) - (xi3(1,2,3) + xi3(1,2,5) + xi3(1,3,5) + ...
                 xi3(2,3,5)))/((x(k+1) - x(k-2))*(x(k+1) - x(k-1))* ...
                               (x(k+1) - x(k))  *(x(k+1) - x(k+2)));        
        w5 = (4*xi3(3,3,3) - 3*(x(k-2) + x(k-1) + x(k) + x(k+1))*xi2(3,3) + ...
              2*(xi2(1,2) + xi2(1,3) + xi2(1,4) + xi2(2,3) + xi2(2,4) + ...
                 xi2(3,4))*x(k) - (xi3(1,2,3) + xi3(1,2,4) + xi3(1,3,4) + ...
                 xi3(2,3,4)))/((x(k+2) - x(k-2))*(x(k+2) - x(k-1))* ...
                               (x(k+2) - x(k))  *(x(k+2) - x(k+1)));        
        d(k) = w1*y(k-2) + w2*y(k-1) + w3*y(k) + w4*y(k+1) + w5*y(k+2);
    end

    for i = 1:5
        for j = 1:5
            xi2(i,j) = x(n-5+i)*x(n-5+j); 
            for k = 1:5
                xi3(i,j,k) = x(n-5+i)*x(n-5+j)*x(n-5+k);
            end
        end
    end

    w1 = (4*xi3(4,4,4) - 3*(x(n-3) + x(n-2) + x(n-1) + x(n))*xi2(4,4) + ...
          2*(xi2(2,3) + xi2(2,4) + xi2(2,5) + xi2(3,4) + xi2(3,5) + ...
             xi2(4,5))*x(n-1) - (xi3(2,3,4) + xi3(2,3,5) + xi3(2,4,5) + ...
             xi3(3,4,5)))/((x(n-4) - x(n-3))*(x(n-4) - x(n-2))* ...
                           (x(n-4) - x(n-1))*(x(n-4) - x(n)));        
    w2 = (4*xi3(4,4,4) - 3*(x(n-4) + x(n-2) + x(n-1) + x(n))*xi2(4,4) + ...
          2*(xi2(1,3) + xi2(1,4) + xi2(1,5) + xi2(3,4) + xi2(3,5) + ...
             xi2(4,5))*x(n-1) - (xi3(1,3,4) + xi3(1,3,5) + xi3(1,4,5) + ...
             xi3(3,4,5)))/((x(n-3) - x(n-4))*(x(n-3) - x(n-2))* ...
                           (x(n-3) - x(n-1))*(x(n-3) - x(n)));        
    w3 = (4*xi3(4,4,4) - 3*(x(n-4) + x(n-3) + x(n-1) + x(n))*xi2(4,4) + ...
          2*(xi2(1,2) + xi2(1,4) + xi2(1,5) + xi2(2,4) + xi2(2,5) + ...
             xi2(4,5))*x(n-1) - (xi3(1,2,4) + xi3(1,2,5) + xi3(1,4,5) + ...
             xi3(2,4,5)))/((x(n-2) - x(n-4))*(x(n-2) - x(n-3))* ...
                           (x(n-2) - x(n-1))*(x(n-2) - x(n)));        
    w4 = (4*xi3(4,4,4) - 3*(x(n-4) + x(n-3) + x(n-2) + x(n))*xi2(4,4) + ...
          2*(xi2(1,2) + xi2(1,3) + xi2(1,5) + xi2(2,3) + xi2(2,5) + ...
             xi2(3,5))*x(n-1) - (xi3(1,2,3) + xi3(1,2,5) + xi3(1,3,5) + ...
             xi3(2,3,5)))/((x(n-1) - x(n-4))*(x(n-1) - x(n-3))* ...
                           (x(n-1) - x(n-2))*(x(n-1) - x(n)));        
    w5 = (4*xi3(4,4,4) - 3*(x(n-4) + x(n-3) + x(n-2) + x(n-1))*xi2(4,4) + ...
          2*(xi2(1,2) + xi2(1,3) + xi2(1,4) + xi2(2,3) + xi2(2,4) + ...
             xi2(3,4))*x(n-1) - (xi3(1,2,3) + xi3(1,2,4) + xi3(1,3,4) + ...
             xi3(2,3,4)))/((x(n) - x(n-4))*(x(n) - x(n-3))* ...
                           (x(n) - x(n-2))*(x(n) - x(n-1)));        
    d(n-1) = w1*y(n-4) + w2*y(n-3) + w3*y(n-2) + w4*y(n-1) + w5*y(n);

    w1 = (4*xi3(5,5,5) - 3*(x(n-3) + x(n-2) + x(n-1) + x(n))*xi2(5,5) + ...
          2*(xi2(2,3) + xi2(2,4) + xi2(2,5) + xi2(3,4) + xi2(3,5) + ...
             xi2(4,5))*x(n) - (xi3(2,3,4) + xi3(2,3,5) + xi3(2,4,5) + ...
             xi3(3,4,5)))/((x(n-4) - x(n-3))*(x(n-4) - x(n-2))* ...
                           (x(n-4) - x(n-1))*(x(n-4) - x(n)));        
    w2 = (4*xi3(5,5,5) - 3*(x(n-4) + x(n-2) + x(n-1) + x(n))*xi2(5,5) + ...
          2*(xi2(1,3) + xi2(1,4) + xi2(1,5) + xi2(3,4) + xi2(3,5) + ...
             xi2(4,5))*x(n) - (xi3(1,3,4) + xi3(1,3,5) + xi3(1,4,5) + ...
             xi3(3,4,5)))/((x(n-3) - x(n-4))*(x(n-3) - x(n-2))* ...
                           (x(n-3) - x(n-1))*(x(n-3) - x(n)));        
    w3 = (4*xi3(5,5,5) - 3*(x(n-4) + x(n-3) + x(n-1) + x(n))*xi2(5,5) + ...
          2*(xi2(1,2) + xi2(1,4) + xi2(1,5) + xi2(2,4) + xi2(2,5) + ...
             xi2(4,5))*x(n) - (xi3(1,2,4) + xi3(1,2,5) + xi3(1,4,5) + ...
             xi3(2,4,5)))/((x(n-2) - x(n-4))*(x(n-2) - x(n-3))* ...
                           (x(n-2) - x(n-1))*(x(n-2) - x(n)));        
    w4 = (4*xi3(5,5,5) - 3*(x(n-4) + x(n-3) + x(n-2) + x(n))*xi2(5,5) + ...
          2*(xi2(1,2) + xi2(1,3) + xi2(1,5) + xi2(2,3) + xi2(2,5) + ...
             xi2(3,5))*x(n) - (xi3(1,2,3) + xi3(1,2,5) + xi3(1,3,5) + ...
             xi3(2,3,5)))/((x(n-1) - x(n-4))*(x(n-1) - x(n-3))* ...
                           (x(n-1) - x(n-2))*(x(n-1) - x(n)));        
    w5 = (4*xi3(5,5,5) - 3*(x(n-4) + x(n-3) + x(n-2) + x(n-1))*xi2(5,5) + ...
          2*(xi2(1,2) + xi2(1,3) + xi2(1,4) + xi2(2,3) + xi2(2,4) + ...
             xi2(3,4))*x(n) - (xi3(1,2,3) + xi3(1,2,4) + xi3(1,3,4) + ...
             xi3(2,3,4)))/((x(n) - x(n-4))*(x(n) - x(n-3))* ...
                           (x(n) - x(n-2))*(x(n) - x(n-1)));        
    d(n) = w1*y(n-4) + w2*y(n-3) + w3*y(n-2) + w4*y(n-1) + w5*y(n);
    
    case 42 % Hyman nonuniform formulas; 'O(h^4)' for the centered, 
            % 'O(h^3)' for the one-sided and partly one-sided 
    k = 3:n-2;
    d(1)   = (-22*y(1) + 36*y(2) - 18*y(3) + 4*y(4)) / ...
             (-22*x(1) + 36*x(2) - 18*x(3) + 4*x(4));
    d(2)   = (-2*y(1) - 3*y(2) + 6*y(3) - y(4)) / ...
             (-2*x(1) - 3*x(2) + 6*x(3) - x(4));
    d(k)   = (-y(k+2) + 8*y(k+1) - 8*y(k-1) + y(k-2)) ./ ...
             (-x(k+2) + 8*x(k+1) - 8*x(k-1) + x(k-2));
    d(n-1) = (2*y(n) + 3*y(n-1) - 6*y(n-2) + y(n-3)) / ...
             (2*x(n) + 3*x(n-1) - 6*x(n-2) + x(n-3));
    d(n)   = (22*y(n) - 36*y(n-1) + 18*y(n-2) - 4*y(n-3)) / ...
             (22*x(n) - 36*x(n-1) + 18*x(n-2) - 4*x(n-3));

    case 43 % Modified Hyman: 'O(h^4)' for the one-sided and partly 
            % one-sided also.
    k = 3:n-2;
    d(1) = (-25*y(1) + 48*y(2) - 36*y(3) + 16*y(4) - 3*y(5)) / ...
           (-25*x(1) + 48*x(2) - 36*x(3) + 16*x(4) - 3*x(5));
    d(2) = (-3*y(1) - 10*y(2) + 18*y(3) - 6*y(4) + y(5)) / ...
           (-3*x(1) - 10*x(2) + 18*x(3) - 6*x(4) + x(5));
    d(k)   = (-y(k+2) + 8*y(k+1) - 8*y(k-1) + y(k-2)) ./ ...
             (-x(k+2) + 8*x(k+1) - 8*x(k-1) + x(k-2));
    d(n-1) = (3*y(n) + 10*y(n-1) - 18*y(n-2) + 6*y(n-3) - y(n-4)) / ...
             (3*x(n) + 10*x(n-1) - 18*x(n-2) + 6*x(n-3) - x(n-4));
    d(n)   = (25*y(n) - 48*y(n-1) + 36*y(n-2) - 16*y(n-3) + 3*y(n-4)) / ...
             (25*x(n) - 48*x(n-1) + 36*x(n-2) - 16*x(n-3) + 3*x(n-4));

    case 44 % Nonuniform O(h^4) formulas [in Newton form]
    [s,ds,e,f] = vecdiffs(x,y);

    for k = 1:n-4
        d(k) = s(k) + ds(k)*(x(k) - x(k+1)) + ...
               e(k)*(x(k)*(x(k) - x(k+1) - x(k+2)) + x(k+1)*x(k+2)) + ...
               f(k)*(x(k)^2*(x(k) - x(k+1) - x(k+2) - x(k+3)) + ...
                     x(k)*(x(k+1)*x(k+2) + x(k+1)*x(k+3) + x(k+2)*x(k+3)) - ...
                           x(k+1)*x(k+2)*x(k+3)); 
    end
    w1 = 4*f(n-4);
    w2 = 3*(e(n-4) - f(n-4)*(x(n-4) + x(n-3) + x(n-2) + x(n-1)));
    w3 = 2*(ds(n-4) - e(n-4)*(x(n-4) + x(n-3) + x(n-2)) + ...
            f(n-4)*(x(n-4)*(x(n-3) + x(n-2) + x(n-1)) + ...
            x(n-3)*x(n-2) + x(n-3)*x(n-1) + x(n-2)*x(n-1)));
    rest = s(n-4) - ds(n-4)*(x(n-4) + x(n-3)) + ...
           e(n-4)*(x(n-4)*x(n-3) + x(n-4)*x(n-2) + x(n-3)*x(n-2)) - ...
           f(n-4)*(x(n-3)*x(n-2)*x(n-1) + ...
                   x(n-4)*(x(n-3)*x(n-2) + x(n-3)*x(n-1) + x(n-2)*x(n-1)));
    d(n-3) = w1*x(n-3)^3 + w2*x(n-3)^2 + w3*x(n-3) + rest;
    d(n-2) = w1*x(n-2)^3 + w2*x(n-2)^2 + w3*x(n-2) + rest;
    d(n-1) = w1*x(n-1)^3 + w2*x(n-1)^2 + w3*x(n-1) + rest;
    d(n)   = w1*x(n)  ^3 + w2*x(n)  ^2 + w3*x(n)   + rest;
    
    otherwise % Catch errors
        error('MATLAB:badopt','unrecognised approximation type!');
end

